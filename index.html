<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Бросок кубов — Мутанты</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #222;
      color: #eee;
      max-width: 600px;
      margin: 20px auto;
      padding: 10px;
    }
    h1 {
      text-align: center;
    }

    .dice-container {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .die {
      width: 40px;
      height: 40px;
      line-height: 40px;
      text-align: center;
      border-radius: 6px;
      font-weight: bold;
      font-size: 20px;
      user-select: none;
      border: 2px solid transparent;
      position: relative;
      transform-style: preserve-3d;
    }

    .yellow { background: #ffeb3b; color: #222; }
    .green  { background: #4caf50; color: #fff; }
    .black  { background: #333; color: #eee; border: 1px solid #555; }

    .success { color: #0f0; font-weight: bold; }
    .mutation { color: #f33; font-weight: bold; }
    .gear-damage { border: 2px solid #f33 !important; }

    .rolling {
      animation: roll 0.5s ease-in-out;
    }

    @keyframes roll {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }

    button {
      background: #4caf50;
      border: none;
      color: white;
      padding: 10px 16px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    button:disabled {
      background: #888;
      cursor: not-allowed;
    }

    #results {
      margin-top: 20px;
      text-align: center;
    }

    .input-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 5px 0;
    }

    .input-row label {
      flex: 1;
    }

    .input-row input {
      width: 50px;
      text-align: center;
      background: #111;
      border: 1px solid #444;
      color: #fff;
      padding: 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<h1>Бросок кубов — Мутанты: Точка Отсчёта</h1>

<div class="input-row">
  <label>Жёлтые кубы (характеристика):</label>
  <input id="yellowCount" type="number" min="0" max="5" value="3" />
</div>
<div class="input-row">
  <label>Зелёные кубы (навык):</label>
  <input id="greenCount" type="number" min="0" max="5" value="3" />
</div>
<div class="input-row">
  <label>Чёрные кубы (снаряжение):</label>
  <input id="blackCount" type="number" min="0" max="5" value="1" />
</div>

<div>
  <button id="rollBtn">Бросить кубы</button>
  <button id="riskBtn" disabled>Рискованный бросок</button>
</div>

<div id="results"></div>

<script>
  let lastRoll = { yellow: [], green: [], black: [] };
  let riskUsed = false;
  let rerollFlags = { yellow: [], green: [], black: [] };

  function rollDice() {
    return Math.floor(Math.random() * 6) + 1;
  }

  function getRiskableDice(diceArray) {
    return diceArray.map(val => val !== 1 && val !== 6);
  }

  function createDiceElements(arr, colorClass, rerolls = [], isRiskyRoll = false) {
    return arr.map((val, i) => {
      const span = document.createElement('span');
      span.className = 'die ' + colorClass;

      // Для обычного броска или перебрасываемых кубиков при рискованном броске: анимация и "?"
      if (!isRiskyRoll || rerolls[i]) {
        span.classList.add('rolling');
        span.textContent = '?';
        setTimeout(() => {
          span.textContent = val;
          if (val === 6) span.classList.add('success');
          if (val === 1) span.classList.add('mutation');
          if (colorClass === 'black' && val === 1) {
            span.classList.add('gear-damage');
          }
        }, 500);
      } else {
        // Для 1 и 6 при рискованном броске: сразу показываем значение без анимации и "?"
        span.textContent = val;
        if (val === 6) span.classList.add('success');
        if (val === 1) span.classList.add('mutation');
        if (colorClass === 'black' && val === 1) {
          span.classList.add('gear-damage');
        }
      }

      return span;
    });
  }

  function showResults(isRiskyRoll = false) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    const yellowDice = createDiceElements(lastRoll.yellow, 'yellow', rerollFlags.yellow, isRiskyRoll);
    const greenDice  = createDiceElements(lastRoll.green, 'green', rerollFlags.green, isRiskyRoll);
    const blackDice  = createDiceElements(lastRoll.black, 'black', rerollFlags.black, isRiskyRoll);

    const addContainer = (label, dice) => {
      const container = document.createElement('div');
      container.className = 'dice-container';
      dice.forEach(die => container.appendChild(die));
      const labelDiv = document.createElement('div');
      labelDiv.textContent = label;
      resultsDiv.appendChild(labelDiv);
      resultsDiv.appendChild(container);
    };

    addContainer('Жёлтые кубы:', yellowDice);
    addContainer('Зелёные кубы:', greenDice);
    addContainer('Чёрные кубы:', blackDice);

    const allDice = [...lastRoll.yellow, ...lastRoll.green, ...lastRoll.black];
    const successCount = allDice.filter(v => v === 6).length;
    const mutationCount = [...lastRoll.yellow, ...lastRoll.green].filter(v => v === 1).length;
    const gearDamage = lastRoll.black.filter(v => v === 1).length;

    const summary = document.createElement('div');
    summary.style.marginTop = '10px';
    summary.innerHTML = `<b>Успехов:</b> ${successCount} | <b>Мутаций:</b> ${mutationCount} | <b>Повреждений снаряжения:</b> ${gearDamage}`;
    setTimeout(() => resultsDiv.appendChild(summary), 500);

    if (riskUsed) {
      const riskNote = document.createElement('div');
      riskNote.style.color = '#ff6600';
      riskNote.style.marginTop = '10px';
      riskNote.textContent = 'Рискованный бросок уже использован.';
      setTimeout(() => resultsDiv.appendChild(riskNote), 500);
    }
  }

  document.getElementById('rollBtn').addEventListener('click', () => {
    riskUsed = false;
    document.getElementById('riskBtn').disabled = true;

    const yellow = parseInt(document.getElementById('yellowCount').value) || 0;
    const green  = parseInt(document.getElementById('greenCount').value)  || 0;
    const black  = parseInt(document.getElementById('blackCount').value)  || 0;

    if (yellow + green + black === 0) {
      return alert('Выберите хотя бы один кубик!');
    }

    lastRoll.yellow = Array.from({ length: yellow }, rollDice);
    lastRoll.green  = Array.from({ length: green },  rollDice);
    lastRoll.black  = Array.from({ length: black },  rollDice);

    rerollFlags = {
      yellow: Array(lastRoll.yellow.length).fill(true), // Все кубики анимируются при обычном броске
      green:  Array(lastRoll.green.length).fill(true),
      black:  Array(lastRoll.black.length).fill(true)
    };

    if ([...lastRoll.yellow, ...lastRoll.green, ...lastRoll.black].some(v => v !== 1 && v !== 6)) {
      document.getElementById('riskBtn').disabled = false;
    }

    showResults();
  });

  document.getElementById('riskBtn').addEventListener('click', () => {
    if (riskUsed) return;
    riskUsed = true;

    const prevYellow = [...lastRoll.yellow];
    const prevGreen = [...lastRoll.green];
    const prevBlack = [...lastRoll.black];

    const rerollDie = arr => arr.map((val, i) => (val === 1 || val === 6) ? val : rollDice());

    lastRoll.yellow = rerollDie(lastRoll.yellow);
    lastRoll.green  = rerollDie(lastRoll.green);
    lastRoll.black  = rerollDie(lastRoll.black);

    rerollFlags = {
      yellow: prevYellow.map(val => val !== 1 && val !== 6), // Анимация только для кубиков, которые были не 1 и не 6
      green:  prevGreen.map(val => val !== 1 && val !== 6),
      black:  prevBlack.map(val => val !== 1 && val !== 6)
    };

    showResults(true);
    document.getElementById('riskBtn').disabled = true;
  });
</script>

</body>
</html>

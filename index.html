<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Бросок кубов — Мутанты</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #222;
      color: #eee;
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .form-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0;
    }
    .form-row label {
      flex: 1;
    }
    .form-row input {
      flex: 0 0 60px;
      padding: 5px;
      font-size: 16px;
      text-align: center;
      border-radius: 5px;
      border: 1px solid #888;
      background: #333;
      color: #eee;
    }
    .button-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }
    button {
      background: #4caf50;
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s;
    }
    button:disabled {
      background: #888;
      cursor: not-allowed;
    }
    .dice-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 5px;
      margin: 10px 0;
    }
    .die {
      width: 40px;
      height: 40px;
      line-height: 40px;
      text-align: center;
      border-radius: 6px;
      font-weight: bold;
      font-size: 20px;
      user-select: none;
      border: 2px solid transparent;
      transition: 0.2s;
    }
    .yellow { background: #ffeb3b; color: #222; }
    .green  { background: #4caf50; color: #fff; }
    .black  { background: #333; color: #eee; border: 1px solid #555; }
    .success { color: #0f0; font-weight: bold; }
    .mutation { color: #f33; font-weight: bold; }
    .gear-damage { border: 2px solid #f33 !important; }
    .critical-success { background: #00c853 !important; color: white; }

    #results {
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>

<h1>Бросок кубов — Мутанты</h1>

<div class="form-row">
  <label for="yellowCount">Жёлтые кубы (характеристика):</label>
  <input id="yellowCount" type="number" min="0" max="5" value="3" />
</div>
<div class="form-row">
  <label for="greenCount">Зелёные кубы (навык):</label>
  <input id="greenCount" type="number" min="0" max="5" value="3" />
</div>
<div class="form-row">
  <label for="blackCount">Чёрные кубы (снаряжение):</label>
  <input id="blackCount" type="number" min="0" max="5" value="1" />
</div>

<div class="button-row">
  <button id="rollBtn">Бросить</button>
  <button id="riskBtn" disabled>Риск</button>
</div>

<div id="results"></div>

<script>
  let lastRoll = { yellow: [], green: [], black: [] };
  let riskUsed = false;
  let rerollFlags = { yellow: [], green: [], black: [] };

  function rollDice() {
    return Math.floor(Math.random() * 6) + 1;
  }

  function getRiskableDice(arr) {
    return arr.map(val => val !== 1 && val !== 6);
  }

  function createDiceElements(arr, colorClass, rerolls = []) {
    return arr.map((val, i) => {
      const span = document.createElement('span');
      span.className = 'die ' + colorClass;
      span.textContent = val;

      if (val === 6) span.classList.add('success');
      if (val === 1) span.classList.add('mutation');
      if (colorClass === 'black' && val === 1) span.classList.add('gear-damage');
      if (val === 6 && rerolls[i]) span.classList.add('critical-success');

      return span;
    });
  }

  function showResults() {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    const yellowDice = createDiceElements(lastRoll.yellow, 'yellow', rerollFlags.yellow);
    const greenDice  = createDiceElements(lastRoll.green, 'green', rerollFlags.green);
    const blackDice  = createDiceElements(lastRoll.black, 'black', rerollFlags.black);

    const addDiceGroup = (label, dice) => {
      const container = document.createElement('div');
      container.innerHTML = `<b>${label}</b>`;
      const diceRow = document.createElement('div');
      diceRow.className = 'dice-container';
      dice.forEach(die => diceRow.appendChild(die));
      container.appendChild(diceRow);
      resultsDiv.appendChild(container);
    };

    addDiceGroup('Жёлтые:', yellowDice);
    addDiceGroup('Зелёные:', greenDice);
    addDiceGroup('Чёрные:', blackDice);

    const allDice = [...lastRoll.yellow, ...lastRoll.green, ...lastRoll.black];
    const successCount = allDice.filter(v => v === 6).length;
    const mutationCount = [...lastRoll.yellow, ...lastRoll.green].filter(v => v === 1).length;
    const gearDamage = lastRoll.black.filter(v => v === 1).length;

    const summary = document.createElement('div');
    summary.style.marginTop = '10px';
    summary.innerHTML = `<b>Успехов:</b> ${successCount} | <b>Мутаций:</b> ${mutationCount} | <b>Повреждений снаряжения:</b> ${gearDamage}`;
    resultsDiv.appendChild(summary);

    if (riskUsed) {
      const riskNote = document.createElement('div');
      riskNote.style.color = '#ff6600';
      riskNote.style.marginTop = '10px';
      riskNote.textContent = 'Рискованный бросок уже использован.';
      resultsDiv.appendChild(riskNote);
    }
  }

  document.getElementById('rollBtn').addEventListener('click', () => {
    riskUsed = false;
    document.getElementById('riskBtn').disabled = true;

    const yellow = parseInt(document.getElementById('yellowCount').value) || 0;
    const green  = parseInt(document.getElementById('greenCount').value)  || 0;
    const black  = parseInt(document.getElementById('blackCount').value)  || 0;

    if (yellow + green + black === 0) {
      return alert('Выберите хотя бы один кубик!');
    }

    lastRoll.yellow = Array.from({ length: yellow }, rollDice);
    lastRoll.green  = Array.from({ length: green },  rollDice);
    lastRoll.black  = Array.from({ length: black },  rollDice);

    rerollFlags = {
      yellow: getRiskableDice(lastRoll.yellow),
      green:  getRiskableDice(lastRoll.green),
      black:  getRiskableDice(lastRoll.black)
    };

    if ([...rerollFlags.yellow, ...rerollFlags.green, ...rerollFlags.black].some(r => r)) {
      document.getElementById('riskBtn').disabled = false;
    }

    showResults();
  });

  document.getElementById('riskBtn').addEventListener('click', () => {
    if (riskUsed) return;
    riskUsed = true;

    const rerollDie = arr => arr.map((val, i) => (val === 1 || val === 6) ? val : rollDice());

    lastRoll.yellow = rerollDie(lastRoll.yellow);
    lastRoll.green  = rerollDie(lastRoll.green);
    lastRoll.black  = rerollDie(lastRoll.black);

    showResults();
    document.getElementById('riskBtn').disabled = true;
  });
</script>

</body>
</html>
